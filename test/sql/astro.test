# name: test/sql/astro.test
# description: test astro extension
# group: [sql]

# Before we load the extension, this will fail
statement error
SELECT astro_angular_separation(45.0, 30.0, 46.0, 31.0);
----
Catalog Error: Scalar Function with name astro_angular_separation does not exist!

# Require statement will ensure this test is run with this extension loaded
require astro

# ============================================
# Physical Constants
# ============================================

query I
SELECT astro_const_c() = 299792458;
----
true

query I
SELECT astro_const_G() > 6.67e-11 AND astro_const_G() < 6.68e-11;
----
true

query I
SELECT astro_const_AU() > 1.49e11;
----
true

query I
SELECT astro_const_M_sun() > 1.98e30;
----
true

# ============================================
# Unit Conversions
# ============================================

query I
SELECT astro_unit_AU(1.0) = astro_const_AU();
----
true

query I
SELECT astro_unit_pc(1.0) > 3e16;
----
true

query I
SELECT astro_unit_length_to_m(1.0, 'AU') = astro_const_AU();
----
true

query I
SELECT astro_unit_mass_to_kg(1.0, 'M_sun') = astro_const_M_sun();
----
true

query I
SELECT astro_unit_time_to_s(1.0, 'yr') > 3.15e7;
----
true

# ============================================
# Angular Separation
# ============================================

query I
SELECT astro_angular_separation(45.0, 30.0, 46.0, 31.0) > 0;
----
true

query I
SELECT astro_angular_separation(45.0, 30.0, 45.0, 30.0) = 0;
----
true

query I
SELECT astro_angular_separation(0.0, 0.0, 180.0, 0.0) = 180.0;
----
true

# ============================================
# Coordinate Transformations
# ============================================

query I
SELECT (astro_radec_to_xyz(0.0, 0.0, 1.0)).x_m = 1.0;
----
true

query I
SELECT (astro_radec_to_xyz(90.0, 0.0, 1.0)).y_m > 0.99;
----
true

query I
SELECT (astro_radec_to_xyz(0.0, 90.0, 1.0)).z_m > 0.99;
----
true

# ============================================
# Photometry
# ============================================

query I
SELECT astro_mag_to_flux(15.0, 25.0) > 0;
----
true

query I
SELECT astro_mag_to_flux(10.0, 25.0) > astro_mag_to_flux(15.0, 25.0);
----
true

query I
SELECT astro_flux_to_mag(1000.0, 25.0) > 0;
----
true

query I
SELECT astro_absolute_mag(10.0, 100.0) = 5.0;
----
true

query I
SELECT astro_distance_modulus(1000.0) = 10.0;
----
true

# ============================================
# Cosmology
# ============================================

query I
SELECT astro_luminosity_distance(0.1, 70.0) > 0;
----
true

query I
SELECT astro_luminosity_distance(0.5, 70.0) > astro_luminosity_distance(0.1, 70.0);
----
true

query I
SELECT astro_comoving_distance(1.0, 70.0) > 0;
----
true

# ============================================
# Body Models
# ============================================

query I
SELECT (astro_body_star_ms(1.0)).mass_kg > 1.9e30;
----
true

query I
SELECT (astro_body_star_ms(1.0)).radius_m > 6.9e8;
----
true

query I
SELECT (astro_body_star_ms(1.0)).body_type = 'main_sequence_star';
----
true

query I
SELECT (astro_body_star_white_dwarf(0.6)).body_type = 'white_dwarf';
----
true

query I
SELECT (astro_body_star_neutron(1.4)).radius_m < 20000;
----
true

query I
SELECT (astro_body_black_hole(10.0)).radius_m > 0;
----
true

query I
SELECT (astro_body_planet_rocky(1.0)).body_type = 'rocky_planet';
----
true

query I
SELECT (astro_body_planet_gas_giant(1.0)).body_type = 'gas_giant';
----
true

query I
SELECT (astro_body_planet_ice_giant(17.0)).body_type = 'ice_giant';
----
true

query I
SELECT (astro_body_asteroid(500.0, 2000.0)).body_type = 'asteroid';
----
true

query I
SELECT (astro_body_brown_dwarf(50.0)).body_type = 'brown_dwarf';
----
true

# ============================================
# Orbital Mechanics
# ============================================

query I
SELECT astro_orbit_period(1.496e11, 1.989e30) > 3.1e7;
----
true

query I
SELECT astro_orbit_mean_motion(1.496e11, 1.989e30) > 0;
----
true

# ============================================
# Spatial Sectors
# ============================================

query I
SELECT (astro_sector_id(1.0, 0.0, 0.0, 3)).level = 3;
----
true

# ============================================
# NULL Handling
# ============================================

query I
SELECT astro_angular_separation(NULL, 30.0, 46.0, 31.0) IS NULL;
----
true

query I
SELECT astro_mag_to_flux(NULL, 25.0) IS NULL;
----
true

query I
SELECT astro_distance_modulus(NULL) IS NULL;
----
true

# ============================================
# Batch Processing
# ============================================

query I
SELECT COUNT(*) FROM (
    SELECT astro_angular_separation(ra, dec, ra+1, dec+1) as sep
    FROM (VALUES (0.0, 0.0), (45.0, 30.0), (90.0, 60.0), (180.0, -30.0)) AS coords(ra, dec)
) WHERE sep > 0;
----
4

query I
SELECT COUNT(*) FROM (
    SELECT
        astro_angular_separation(ra, dec, 0, 0) as sep,
        astro_mag_to_flux(mag, 25.0) as flux,
        astro_distance_modulus(dist) as dm
    FROM (VALUES
        (0.0, 0.0, 15.0, 100.0),
        (45.0, 30.0, 12.5, 500.0),
        (90.0, -45.0, 18.2, 1000.0)
    ) AS data(ra, dec, mag, dist)
) WHERE sep >= 0 AND flux > 0 AND dm > 0;
----
3
